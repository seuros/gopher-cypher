name: Go

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  NEO4J_USER: neo4j
  NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD || 'activecypher' }}
  MEMGRAPH_USER: memgraph
  MEMGRAPH_PASSWORD: ${{ secrets.MEMGRAPH_PASSWORD || 'activecypher' }}

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      neo4j:
        image: neo4j:latest
        ports:
          - "7687:7687"
        env:
          NEO4J_AUTH: ${{ env.NEO4J_USER }}/${{ env.NEO4J_PASSWORD }}
        options: >-
          --health-cmd "wget -O /dev/null http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      memgraph:
        image: memgraph/memgraph-mage:latest
        ports:
          - "7688:7687"
          - "7444:7444"
        env:
          MEMGRAPH_USER: ${{ env.MEMGRAPH_USER }}
          MEMGRAPH_PASSWORD: ${{ env.MEMGRAPH_PASSWORD }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.x'

      - name: Wait for services to be ready
        run: |
          echo "Waiting for Neo4j..."
          timeout 60s bash -c 'until nc -z localhost 7687; do sleep 1; done'
          echo "Waiting for Memgraph..."
          timeout 60s bash -c 'until nc -z localhost 7688; do sleep 1; done'

      - name: Test
        run: go test -v ./...
        env:
          NEO4J_HOST: localhost
          NEO4J_PORT: "7687"
          NEO4J_USER: ${{ env.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ env.NEO4J_PASSWORD }}
          MEMGRAPH_HOST: localhost
          MEMGRAPH_PORT: "7688"
          MEMGRAPH_USER: ${{ env.MEMGRAPH_USER }}
          MEMGRAPH_PASSWORD: ${{ env.MEMGRAPH_PASSWORD }}
